<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher's Log Pro</title>
    
    <!-- 
      【Teacher's Log Pro v4.0 (Easy Config)】
      
      [修正内容]
      - 設定画面からFirebaseの設定情報（Config）を直接貼り付けて更新できる機能を追加。
      - HTMLファイルを直接編集しなくても、プロジェクトの変更に対応可能にしました。
      - エラーハンドリングを強化し、詳細なエラーコードを表示。
    -->

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        @media print {
            body { background-color: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-container { 
                width: 100%; 
                border: 1px solid #000;
                font-size: 10pt;
            }
            .print-row { page-break-inside: avoid; }
            .print-border { border: 1px solid #000; }
            .h-screen { height: auto !important; }
            .overflow-hidden { overflow: visible !important; }
            .overflow-auto { overflow: visible !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        //  FIREBASE CONFIGURATION (Default)
        // ==========================================
        // ※ 設定画面から入力された値が優先されます
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyCPAOKwJZuCbR6WyC28itym-zCiuJsNBzY",
            authDomain: "teachers-log-2.firebaseapp.com",
            projectId: "teachers-log-2",
            storageBucket: "teachers-log-2.firebasestorage.app",
            messagingSenderId: "204327363691",
            appId: "1:204327363691:web:a8ea8aaabcba1e7090fd2e"
        };
        // ==========================================

        let db = null;
        let auth = null;
        
        // 1. LocalStorageから設定を読み込む
        const savedConfigStr = localStorage.getItem('teacherLogFirebaseConfig');
        let activeConfig = defaultFirebaseConfig;
        
        if (savedConfigStr) {
            try {
                activeConfig = JSON.parse(savedConfigStr);
                console.log("Using custom Firebase config from localStorage");
            } catch (e) {
                console.error("Failed to parse saved config", e);
            }
        } else if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            // Environment variable fallback
            activeConfig = JSON.parse(__firebase_config);
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'teachers-log-pro';
        const useCloud = activeConfig.apiKey !== undefined && activeConfig.apiKey !== "";

        if (useCloud) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(activeConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
            } catch (e) {
                console.error("Firebase init error:", e);
                // 初期化エラーは画面ロード後にアラート等で出すのが親切だが、ここではログのみ
            }
        }

        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const APP_VERSION = "v4.0";
        const WEEK_DAYS = ['月', '火', '水', '木', '金', '土'];
        
        const COLOR_PALETTE = {
            red: { label: '赤', bg: 'bg-red-500', bgLight: 'bg-red-100', text: 'text-red-800', border: 'border-red-600', ring: 'ring-red-500' },
            orange: { label: '橙', bg: 'bg-orange-500', bgLight: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-600', ring: 'ring-orange-500' },
            yellow: { label: '黄', bg: 'bg-yellow-400', bgLight: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-500', ring: 'ring-yellow-400' },
            green: { label: '緑', bg: 'bg-green-500', bgLight: 'bg-green-100', text: 'text-green-800', border: 'border-green-600', ring: 'ring-green-500' },
            blue: { label: '青', bg: 'bg-blue-500', bgLight: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-600', ring: 'ring-blue-500' },
            indigo: { label: '藍', bg: 'bg-indigo-500', bgLight: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-600', ring: 'ring-indigo-500' },
            purple: { label: '紫', bg: 'bg-purple-500', bgLight: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-600', ring: 'ring-purple-500' },
            gray: { label: '灰', bg: 'bg-gray-500', bgLight: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-600', ring: 'ring-gray-500' },
        };

        const DEFAULT_CLASSES = [
            { name: '1A', color: 'red' }, { name: '1B', color: 'red' },
            { name: '2A', color: 'green' }, { name: '2B', color: 'green' }, 
            { name: '3A', color: 'blue' }, { name: '3B', color: 'blue' },   
            { name: '道徳', color: 'yellow' }, { name: '総学', color: 'orange' },
            { name: 'HR', color: 'indigo' }, { name: '監督', color: 'gray' }, { name: 'その他', color: 'gray' }
        ];

        const TIME_SLOTS = [
            { id: 'morning', label: '朝・行事', type: 'special', height: 'h-20' },
            { id: '1', label: '1限', type: 'class', height: 'h-24' },
            { id: '2', label: '2限', type: 'class', height: 'h-24' },
            { id: '3', label: '3限', type: 'class', height: 'h-24' },
            { id: '4', label: '4限', type: 'class', height: 'h-24' },
            { id: 'lunch', label: '昼休み', type: 'break', height: 'h-8' },
            { id: '5', label: '5限', type: 'class', height: 'h-24' },
            { id: '6', label: '6限', type: 'class', height: 'h-24' },
            { id: '7', label: '7限', type: 'class', height: 'h-24' },
            { id: 'after', label: '帰りHR', type: 'special', height: 'h-14' },
            { id: 'memo', label: 'メモ', type: 'memo', height: 'h-20' },
        ];

        const formatDateKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const getMonday = (d) => {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            return new Date(d.setDate(diff));
        };

        const generateId = () => Math.random().toString(36).substring(2, 10).toUpperCase();

        const guessColor = (name) => {
            if (name.startsWith('1')) return 'red';
            if (name.startsWith('2')) return 'green';
            if (name.startsWith('3')) return 'blue'; 
            if (name.includes('道徳')) return 'yellow';
            if (name.includes('HR')) return 'indigo';
            return 'gray';
        };

        // Icons
        const Icons = {
            ChevronLeft: ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>,
            Calendar: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            List: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Settings: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Download: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            X: ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            BarChart: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>,
            Cloud: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M20 16.952c1.235-.976 2-2.528 2-4.162 0-2.761-2.238-5-5-5-.403 0-.792.051-1.168.146C15.394 5.378 13.068 4 10.5 4 6.91 4 4 6.91 4 10.5c0 1.637.595 3.125 1.583 4.29"/></svg>,
            Plus: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>,
            Trash: ({size = 16, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            DownloadCloud: ({size = 16, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,
            Printer: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Search: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>,
            Save: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            RefreshCw: ({size = 20, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Wifi: ({size = 16, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
            ClipboardCheck: ({size = 16, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>,
        };

        // --- Components ---

        const ClassSelector = ({ selectedClass, onSelect, classes }) => {
            const getButtonStyle = (clsObj) => {
                const base = "px-3 py-2 rounded-lg text-sm font-bold border transition-all shadow-sm ";
                const isSelected = selectedClass === clsObj.name;
                const colorTheme = COLOR_PALETTE[clsObj.color || 'gray'];
                
                let colorClass = "";
                if (isSelected) {
                    colorClass = `${colorTheme.bg} text-white ${colorTheme.border} ring-2 ring-offset-1 ${colorTheme.ring} transform scale-105 z-10`;
                } else {
                    colorClass = `${colorTheme.bgLight} ${colorTheme.text} border-gray-200 opacity-80 hover:opacity-100 hover:scale-105`;
                }

                return `${base} ${colorClass}`;
            };

            return (
                <div className="flex flex-wrap gap-2">
                    {classes.map((c, idx) => (
                        <button
                            key={`${c.name}-${idx}`}
                            onClick={() => onSelect(c.name)}
                            className={getButtonStyle(c)}
                        >
                            {c.name}
                        </button>
                    ))}
                </div>
            );
        };

        const SlotModal = ({ isOpen, onClose, date, slotId, data, onSave, classOptions }) => {
            if (!isOpen) return null;

            const slotDef = TIME_SLOTS.find(s => s.id === slotId);
            const isClassSlot = slotDef?.type === 'class';
            // Default to empty string (no class selected)
            const defaultClassId = '';
            const initialData = data || { plan: '', actual: '', classId: defaultClassId, memo: '' };

            const [localData, setLocalData] = useState(initialData);

            useEffect(() => {
                let loadedData = data || { plan: '', actual: '', classId: defaultClassId, memo: '' };
                if (!isClassSlot && loadedData.actual && !loadedData.plan.includes(loadedData.actual)) {
                    loadedData = { 
                        ...loadedData, 
                        plan: loadedData.plan ? `${loadedData.plan}\n\n---\n${loadedData.actual}` : loadedData.actual,
                        actual: ''
                    };
                }
                setLocalData(loadedData);
            }, [data, slotId, isClassSlot, defaultClassId, isOpen]);

            const handleChange = (field, value) => {
                setLocalData(prev => ({ ...prev, [field]: value }));
            };

            const handleSave = () => {
                onSave(date, slotId, localData);
                onClose();
            };
            
            const handleClassSelect = (clsName) => {
                if (localData.classId === clsName) {
                    handleChange('classId', '');
                } else {
                    handleChange('classId', clsName);
                }
            };

            const dateStr = new Date(date).toLocaleDateString('ja-JP', { month: 'long', day: 'numeric', weekday: 'long' });

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl overflow-hidden h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b flex justify-between items-center bg-gray-800 text-white shrink-0">
                            <div>
                                <h2 className="text-lg font-bold">{dateStr}</h2>
                                <span className="text-sm bg-gray-700 px-2 py-0.5 rounded text-gray-200">{slotDef?.label}</span>
                            </div>
                            <button onClick={onClose} className="hover:bg-gray-700 p-2 rounded-full transition"><Icons.X /></button>
                        </div>
                        
                        <div className="p-5 overflow-y-auto custom-scrollbar flex-1 flex flex-col">
                            {isClassSlot ? (
                                <>
                                    <div className="mb-6 shrink-0">
                                        <label className="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">クラス選択（タップで解除）</label>
                                        <ClassSelector 
                                            selectedClass={localData.classId} 
                                            onSelect={handleClassSelect} 
                                            classes={classOptions} 
                                        />
                                    </div>

                                    <div className="space-y-4">
                                        <div className="space-y-1">
                                            <div className="flex items-center justify-between">
                                                <label className="text-sm font-bold text-gray-700">予定 (Plan)</label>
                                            </div>
                                            <textarea 
                                                className="w-full border-2 border-gray-200 rounded-lg p-3 text-base min-h-[100px] focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                                placeholder="指導のねらい、活動内容..."
                                                value={localData.plan || ''}
                                                onChange={(e) => handleChange('plan', e.target.value)}
                                            />
                                        </div>
                                        
                                        <div className="space-y-1">
                                            <label className="text-sm font-bold text-gray-700">実施記録・振り返り (Actual)</label>
                                            <textarea 
                                                className="w-full border-2 border-yellow-100 bg-yellow-50 rounded-lg p-3 text-base min-h-[80px] focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all"
                                                placeholder="生徒の様子、変更点、メモ..."
                                                value={localData.actual || ''}
                                                onChange={(e) => handleChange('actual', e.target.value)}
                                            />
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div className="flex-1 flex flex-col h-full">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">内容</label>
                                    <textarea 
                                        className="w-full border-2 border-gray-200 rounded-lg p-4 text-base flex-1 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none leading-relaxed"
                                        placeholder="内容、連絡事項、行事の詳細など..."
                                        value={localData.plan || ''}
                                        onChange={(e) => handleChange('plan', e.target.value)}
                                    />
                                </div>
                            )}
                        </div>

                        <div className="p-4 border-t bg-gray-50 flex justify-end gap-3 shrink-0">
                            <button onClick={onClose} className="px-5 py-2.5 rounded-lg text-gray-600 hover:bg-gray-200 font-medium transition">キャンセル</button>
                            <button onClick={handleSave} className="px-8 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-bold shadow-md transform active:scale-95 transition">
                                保存
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, classes, onUpdateClasses, syncId, onUpdateSyncId, onTriggerSync, isSyncing, teacherTitle, onUpdateTeacherTitle }) => {
            if (!isOpen) return null;
            const [localClasses, setLocalClasses] = useState([...classes]);
            const [localSyncId, setLocalSyncId] = useState(syncId);
            const [localTeacherTitle, setLocalTeacherTitle] = useState(teacherTitle);
            const [configInput, setConfigInput] = useState('');

            useEffect(() => {
                setLocalClasses([...classes]);
            }, [classes]);

            useEffect(() => {
                setLocalTeacherTitle(teacherTitle);
            }, [teacherTitle]);

            const handleSave = () => {
                const filtered = localClasses.filter(c => c.name.trim() !== '');
                onUpdateClasses(filtered);
                onUpdateSyncId(localSyncId);
                onUpdateTeacherTitle(localTeacherTitle);
                onClose();
            };
            
            const handleSyncClick = () => {
                onUpdateSyncId(localSyncId);
                onTriggerSync(localSyncId);
            };

            const addClass = () => {
                setLocalClasses([...localClasses, { name: '', color: 'gray' }]);
            };

            const removeClass = (index) => {
                const newClasses = [...localClasses];
                newClasses.splice(index, 1);
                setLocalClasses(newClasses);
            };

            const updateClass = (index, field, value) => {
                const newClasses = [...localClasses];
                newClasses[index] = { ...newClasses[index], [field]: value };
                setLocalClasses(newClasses);
            };

            const handleConfigSave = () => {
                if (!configInput.trim()) return;
                
                try {
                    // Try to parse input. Allow both raw JSON and "const firebaseConfig = {...}" format
                    let jsonStr = configInput;
                    const match = configInput.match(/{[\s\S]*}/);
                    if (match) {
                        jsonStr = match[0];
                    }
                    
                    // Simple cleaning for relaxed JSON (keys without quotes) if needed, 
                    // but standard Firebase console output is JS object literal, not strict JSON.
                    // We'll try to eval it safely or ask user to provide strict JSON. 
                    // Ideally, user copies the object literal. 
                    // Since eval is dangerous, let's try a regex-based approach to quote keys or assume valid JSON.
                    // For now, let's assume the user copies the {...} part and it might need formatting.
                    // Actually, easiest is to tell user to format as JSON or use a simple Function constructor 
                    // (sandboxed if possible, but here client side only).
                    
                    // Let's use a safer approach: warn if it fails JSON.parse, 
                    // but also try to allow JS object literal by wrapping in parens and eval-ing (risk accepted as it's local tool)
                    let configObj;
                    try {
                        configObj = JSON.parse(jsonStr);
                    } catch {
                        // Fallback: try evaluating as JS object
                        // Note: Function(...) is safer than eval() but still powerful. 
                        // Since this is a tool for self-use, it's acceptable.
                        configObj = new Function("return " + jsonStr)();
                    }

                    if (configObj && configObj.apiKey) {
                        localStorage.setItem('teacherLogFirebaseConfig', JSON.stringify(configObj));
                        if(confirm("Firebase設定を保存しました。反映するためにページを再読み込みしますか？")) {
                            window.location.reload();
                        }
                    } else {
                        alert("有効なFirebase設定が見つかりませんでした。\n{ apiKey: ... } の形式が含まれているか確認してください。");
                    }
                } catch (e) {
                    console.error(e);
                    alert("設定の解析に失敗しました。コピーした内容が正しいか確認してください。");
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg p-6 w-full max-w-lg max-h-[90vh] flex flex-col">
                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2 flex-shrink-0"><Icons.Settings size={20}/> 設定</h2>
                        
                        <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-6">
                            
                            {/* Title Settings Section */}
                            <div className="mb-4">
                                <label className="block text-sm font-bold text-gray-700 mb-2">肩書き・担任名</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="text"
                                        className="w-full border-2 border-gray-200 rounded p-2 text-base focus:ring-2 focus:ring-blue-500"
                                        value={localTeacherTitle}
                                        onChange={(e) => setLocalTeacherTitle(e.target.value)}
                                        placeholder="例: 1年A組 担任"
                                    />
                                </div>
                            </div>

                            {/* Sync Section */}
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <h3 className="font-bold text-blue-800 text-sm mb-2 flex items-center gap-1"><Icons.Cloud size={16}/> クラウド同期 (iPad連携)</h3>
                                <p className="text-xs text-blue-600 mb-2">
                                    IDを入力して「接続」を押すと、同期を開始します。<br/>
                                    【注意】IDを知っている人は誰でも閲覧可能です。
                                </p>
                                <div className="flex gap-2 items-center">
                                    <input 
                                        type="text"
                                        className="flex-1 border-2 border-blue-200 rounded p-2 text-center font-mono font-bold text-lg tracking-widest text-blue-900 focus:ring-2 focus:ring-blue-500"
                                        value={localSyncId}
                                        onChange={(e) => setLocalSyncId(e.target.value)}
                                        placeholder="SYNC_ID"
                                    />
                                    <button 
                                        onClick={handleSyncClick}
                                        disabled={isSyncing}
                                        className={`px-3 py-2 rounded font-bold text-sm text-white flex items-center gap-1 whitespace-nowrap shadow-sm transition
                                            ${isSyncing ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 active:scale-95'}
                                        `}
                                        title="クラウドと接続し、状態を確認します"
                                    >
                                        <Icons.Wifi size={16} /> 
                                        接続
                                    </button>
                                </div>
                            </div>

                            {/* Advanced Config Section */}
                            <div className="bg-gray-100 p-4 rounded-lg border border-gray-200">
                                <h3 className="font-bold text-gray-700 text-sm mb-2 flex items-center gap-1"><Icons.ClipboardCheck size={16}/> Firebase設定の上書き (上級者向け)</h3>
                                <p className="text-xs text-gray-600 mb-2">
                                    プロジェクトを作り直した場合など、新しい <code>const firebaseConfig = &#123;...&#125;</code> をここに貼り付けて更新できます。
                                </p>
                                <textarea 
                                    className="w-full border rounded p-2 text-xs font-mono h-20 mb-2"
                                    placeholder='const firebaseConfig = { apiKey: "..." ... };'
                                    value={configInput}
                                    onChange={(e) => setConfigInput(e.target.value)}
                                />
                                <div className="text-right">
                                    <button 
                                        onClick={handleConfigSave}
                                        className="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 transition"
                                    >
                                        設定を更新してリロード
                                    </button>
                                </div>
                            </div>

                            {/* Class Settings Section */}
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-bold text-gray-700">クラス・科目設定</label>
                                    <button onClick={addClass} className="flex items-center gap-1 text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200 font-bold">
                                        <Icons.Plus size={14} /> 追加
                                    </button>
                                </div>
                                
                                <div className="space-y-2">
                                    {localClasses.map((cls, idx) => (
                                        <div key={idx} className="flex gap-2 items-center">
                                            <input 
                                                type="text" 
                                                placeholder="クラス名"
                                                className="border rounded p-2 flex-1 text-sm"
                                                value={cls.name}
                                                onChange={(e) => updateClass(idx, 'name', e.target.value)}
                                            />
                                            <select 
                                                className={`border rounded p-2 text-sm w-24 cursor-pointer font-medium ${COLOR_PALETTE[cls.color]?.text} ${COLOR_PALETTE[cls.color]?.bgLight}`}
                                                value={cls.color}
                                                onChange={(e) => updateClass(idx, 'color', e.target.value)}
                                            >
                                                {Object.keys(COLOR_PALETTE).map(key => (
                                                    <option key={key} value={key}>
                                                        {COLOR_PALETTE[key].label}
                                                    </option>
                                                ))}
                                            </select>
                                            <button 
                                                onClick={() => removeClass(idx)}
                                                className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded"
                                            >
                                                <Icons.Trash />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end gap-2 mt-4 pt-4 border-t flex-shrink-0">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition">キャンセル</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow font-bold transition">保存</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ClassHistoryView = ({ data, classes }) => {
            const [selectedClass, setSelectedClass] = useState(classes[0]?.name || '1A');
            const [searchTerm, setSearchTerm] = useState("");

            const history = useMemo(() => {
                const list = [];
                Object.keys(data).sort().reverse().forEach(dateKey => {
                    const dayData = data[dateKey];
                    Object.keys(dayData).forEach(slotId => {
                        const slot = dayData[slotId];
                        // Filter logic
                        const matchesClass = selectedClass === 'ALL' || slot.classId === selectedClass;
                        const matchesSearch = searchTerm === "" || 
                                              (slot.plan && slot.plan.includes(searchTerm)) || 
                                              (slot.actual && slot.actual.includes(searchTerm));

                        if (matchesClass && matchesSearch && (slot.plan || slot.actual)) {
                            list.push({
                                date: dateKey,
                                period: TIME_SLOTS.find(t => t.id === slotId)?.label || slotId,
                                plan: slot.plan,
                                actual: slot.actual,
                                classId: slot.classId
                            });
                        }
                    });
                });
                return list;
            }, [data, selectedClass, searchTerm]);

            return (
                <div className="bg-white rounded shadow p-4 h-full overflow-hidden flex flex-col">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-4 border-b pb-4 gap-4">
                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <Icons.List /> 
                            指導記録検索
                        </h2>
                        <div className="flex gap-2 w-full md:w-auto">
                            <div className="relative flex-1">
                                <Icons.Search className="absolute left-2 top-2.5 text-gray-400" size={16} />
                                <input 
                                    type="text" 
                                    placeholder="キーワード検索..." 
                                    className="pl-8 border p-2 rounded shadow-sm w-full"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <select 
                                value={selectedClass} 
                                onChange={(e) => setSelectedClass(e.target.value)}
                                className="border p-2 rounded shadow-sm"
                            >
                                <option value="ALL">全クラス</option>
                                {classes.map((c, idx) => <option key={idx} value={c.name}>{c.name}</option>)}
                            </select>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-auto custom-scrollbar">
                        {history.length === 0 ? (
                            <div className="text-center text-gray-400 py-10">履歴がありません</div>
                        ) : (
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th className="p-3 border-b font-medium w-32">日付・時限</th>
                                        {selectedClass === 'ALL' && <th className="p-3 border-b font-medium w-24">クラス</th>}
                                        <th className="p-3 border-b font-medium">予定 (Plan)</th>
                                        <th className="p-3 border-b font-medium">実施記録 (Actual)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {history.map((item, idx) => (
                                        <tr key={idx} className="hover:bg-gray-50 border-b">
                                            <td className="p-3 text-sm text-gray-600">
                                                {item.date} <br/>
                                                <span className="text-xs bg-gray-200 px-1 rounded">{item.period}</span>
                                            </td>
                                            {selectedClass === 'ALL' && (
                                                <td className="p-3 text-sm font-bold text-gray-600">{item.classId}</td>
                                            )}
                                            <td className="p-3 text-sm whitespace-pre-wrap">{item.plan}</td>
                                            <td className="p-3 text-sm whitespace-pre-wrap text-blue-800">{item.actual}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            );
        };

        const StatsView = ({ data, classes }) => {
            const counts = useMemo(() => {
                const c = {};
                classes.forEach(cls => c[cls.name] = 0);
                
                Object.values(data).forEach(dayData => {
                    Object.entries(dayData).forEach(([slotId, slotData]) => {
                        if (['1','2','3','4','5','6','7'].includes(slotId) && slotData.classId) {
                            if (c[slotData.classId] === undefined) c[slotData.classId] = 0;
                            c[slotData.classId]++;
                        }
                    });
                });
                return c;
            }, [data, classes]);

            const maxCount = Math.max(...Object.values(counts), 1);

            return (
                <div className="bg-white rounded shadow p-6 h-full overflow-hidden flex flex-col">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 border-b pb-2">授業数集計 (1限〜7限)</h2>
                    
                    <div className="flex-1 overflow-auto custom-scrollbar">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {classes.map((cls, idx) => {
                                const count = counts[cls.name] || 0;
                                const percentage = (count / maxCount) * 100;
                                const colorTheme = COLOR_PALETTE[cls.color || 'gray'];

                                return (
                                    <div key={idx} className="border rounded p-4 flex items-center justify-between shadow-sm bg-gray-50">
                                        <div className="flex-1">
                                            <div className="flex justify-between items-baseline mb-2">
                                                <span className={`font-bold text-lg ${colorTheme.text}`}>{cls.name}</span>
                                                <span className="text-2xl font-bold text-gray-900">{count} <span className="text-xs font-normal text-gray-500">コマ</span></span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2.5">
                                                <div className={`${colorTheme.bg} h-2.5 rounded-full`} style={{ width: `${percentage}%`, minWidth: '5%' }}></div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const MonthView = ({ currentDate, data, onNavigateToWeek, classList }) => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const startingDay = firstDay.getDay(); 
            const diff = startingDay === 0 ? 6 : startingDay - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const grid = [];
            let dayCounter = 1;
            for (let i = 0; i < 6; i++) {
                const row = [];
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < diff) {
                        row.push(null);
                    } else if (dayCounter > daysInMonth) {
                        row.push(null);
                    } else {
                        row.push(new Date(year, month, dayCounter));
                        dayCounter++;
                    }
                }
                grid.push(row);
                if (dayCounter > daysInMonth) break;
            }

            const getClassColorStyle = (clsName) => {
                const clsObj = classList.find(c => c.name === clsName);
                const theme = COLOR_PALETTE[clsObj ? clsObj.color : (guessColor(clsName) || 'gray')];
                return `${theme.bgLight} ${theme.text}`;
            };

            const periodMap = {
                '1': '①', '2': '②', '3': '③', '4': '④', '5': '⑤', '6': '⑥', '7': '⑦'
            };

            return (
                <div className="h-full flex flex-col p-4 overflow-hidden">
                    <div className="bg-white rounded-lg shadow border flex-1 flex flex-col">
                        <div className="grid grid-cols-7 border-b bg-gray-50">
                            {WEEK_DAYS.concat(['日']).map((d, i) => (
                                <div key={i} className={`p-2 text-center text-sm font-bold ${i === 6 ? 'text-red-500' : 'text-gray-600'}`}>
                                    {d}
                                </div>
                            ))}
                        </div>
                        <div className="flex-1 grid grid-rows-5 sm:grid-rows-6">
                            {grid.map((row, rIdx) => (
                                <div key={rIdx} className="grid grid-cols-7 h-full">
                                    {row.map((date, cIdx) => {
                                        if (!date) return <div key={cIdx} className="bg-gray-50/50 border-r border-b"></div>;
                                        
                                        const dateKey = formatDateKey(date);
                                        const dayData = data[dateKey] || {};
                                        const isToday = formatDateKey(new Date()) === dateKey;

                                        const dayClasses = [];
                                        ['1','2','3','4','5','6','7'].forEach(pid => {
                                            const slot = dayData[pid];
                                            if (slot && slot.classId) {
                                                dayClasses.push({ pid, classId: slot.classId });
                                            }
                                        });

                                        return (
                                            <div 
                                                key={cIdx} 
                                                onClick={() => onNavigateToWeek(date)}
                                                className={`
                                                    border-r border-b p-1 relative hover:bg-blue-50 cursor-pointer transition flex flex-col
                                                    ${isToday ? 'bg-blue-50' : ''}
                                                `}
                                            >
                                                <div className="flex justify-between items-start mb-1">
                                                    <span className={`text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-blue-600 text-white' : ''}`}>
                                                        {date.getDate()}
                                                    </span>
                                                </div>
                                                <div className="flex-1 overflow-hidden flex flex-wrap content-start gap-1">
                                                    {dayClasses.map((item, idx) => (
                                                        <span key={idx} className={`text-[10px] font-bold px-1 rounded flex items-center ${getClassColorStyle(item.classId)}`}>
                                                            <span className="mr-0.5 opacity-70">{periodMap[item.pid]}</span>
                                                            {item.classId}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const App = () => {
            const [currentDate, setCurrentDate] = useState(new Date()); 
            const [viewMode, setViewMode] = useState('week'); 
            const [scheduleData, setScheduleData] = useState({}); 
            const [classList, setClassList] = useState(DEFAULT_CLASSES);
            const [teacherTitle, setTeacherTitle] = useState("1年A組 担任");
            
            // Sync State
            const [syncId, setSyncId] = useState(() => {
                const saved = localStorage.getItem('teacherLogSyncId');
                return saved || generateId();
            });
            const [isSyncing, setIsSyncing] = useState(false);
            const [isCloudLoaded, setIsCloudLoaded] = useState(false);

            const [slotModalInfo, setSlotModalInfo] = useState({ isOpen: false, date: null, slotId: null });
            const [isSettingsOpen, setSettingsOpen] = useState(false);

            // --- Persistence & Sync Logic ---

            useEffect(() => {
                const savedData = localStorage.getItem('teachersLogData');
                if (savedData) setScheduleData(JSON.parse(savedData));
                
                const savedClasses = localStorage.getItem('teachersLogClasses');
                if (savedClasses) {
                    const parsed = JSON.parse(savedClasses);
                    if (parsed.length > 0 && typeof parsed[0] === 'string') {
                        const migrated = parsed.map(c => ({ name: c, color: guessColor(c) }));
                        setClassList(migrated);
                    } else {
                        setClassList(parsed);
                    }
                }

                const savedTitle = localStorage.getItem('teacherLogTitle');
                if (savedTitle) setTeacherTitle(savedTitle);
            }, []);

            // Real-time Sync Logic (Replaces manual fetch)
            useEffect(() => {
                if (!useCloud || !auth || !db) return;

                let unsubscribe = () => {};

                const setupRealtimeListener = async () => {
                    // Auth check (ensure signed in)
                    if (!auth.currentUser) {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                         } else {
                            await auth.signInAnonymously();
                         }
                    }

                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('weekly_plans').doc(syncId);
                    
                    unsubscribe = docRef.onSnapshot((doc) => {
                        // ignore local writes to prevent loops/jitters
                        if (doc.metadata.hasPendingWrites) return; 

                        if (doc.exists) {
                            const remoteData = doc.data();
                            // console.log("Realtime update received"); // debug
                            
                            // Merge logic: Update state from remote
                            if (remoteData.schedule) setScheduleData(remoteData.schedule);
                            if (remoteData.classes) {
                                const rClasses = remoteData.classes;
                                if (rClasses.length > 0 && typeof rClasses[0] === 'string') {
                                    setClassList(rClasses.map(c => ({ name: c, color: guessColor(c) })));
                                } else {
                                    setClassList(rClasses);
                                }
                            }
                            if (remoteData.title) setTeacherTitle(remoteData.title);
                            
                            setIsCloudLoaded(true); // Mark as safe to write
                        } else {
                            // Doc doesn't exist yet on cloud.
                            // Only mark loaded if we are sure we connected.
                            setIsCloudLoaded(true); 
                        }
                    }, (error) => {
                        console.error("Sync error:", error);
                    });
                };

                setupRealtimeListener();

                return () => unsubscribe();
            }, [syncId, useCloud]); 

            // Save to Firestore on Change
            // ★ UPDATED: Now returns a boolean promise indicating success
            const saveToCloud = useCallback(async (newSchedule, newClasses, newTitle) => {
                if (!useCloud || !auth) {
                    alert("クラウド機能が無効です。Firebase設定を確認してください。");
                    return false;
                }
                
                // Ensure auth
                if (!auth.currentUser) {
                    try {
                        await auth.signInAnonymously();
                    } catch (e) {
                        console.error("Auth failed:", e);
                        alert(`クラウド認証に失敗しました。\nエラー詳細: ${e.message}\n\nFirebaseコンソールのAuthenticationで「匿名」が有効か、APIキーが正しいか確認してください。`);
                        return false;
                    }
                }
                
                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('weekly_plans').doc(syncId);
                    
                    await docRef.set({
                        schedule: newSchedule,
                        classes: newClasses,
                        title: newTitle,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                    return true;
                } catch (e) {
                    console.error("Cloud save failed:", e);
                    alert(`クラウド保存に失敗しました。\nエラー詳細: ${e.message}\n\nFirestoreの「ルール」タブで、書き込みが許可(allow write: if true)されているか確認してください。`);
                    return false;
                }
            }, [syncId, useCloud]); // Removed isCloudLoaded guard for manual saves

            // Manual Fetch / Connect (Smart Logic)
            const fetchFromCloud = useCallback(async (targetId = syncId) => {
                if (!useCloud || !auth || !db) return;
                setIsSyncing(true);
                try {
                     const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('weekly_plans').doc(targetId);
                     const doc = await docRef.get();
                     
                     if (doc.exists) {
                         // Data found on cloud
                         const remoteData = doc.data();
                         if (window.confirm("【データ受信】\nクラウドに保存されたデータが見つかりました。\n\nクラウドのデータをダウンロードして、表示を上書きしますか？\n（※iPadなど2台目以降の場合は「OK」を押してください）")) {
                             if (remoteData.schedule) setScheduleData(remoteData.schedule);
                             if (remoteData.classes) setClassList(remoteData.classes);
                             if (remoteData.title) setTeacherTitle(remoteData.title);
                             alert("クラウドのデータを取り込みました。");
                         }
                         setIsCloudLoaded(true);
                     } else {
                         // Data NOT found on cloud
                         if (window.confirm("【新規作成】\nクラウドにデータがありませんでした。\n\n現在表示されているデータをクラウドに登録して、この端末を「親」として同期を開始しますか？")) {
                             await saveToCloud(scheduleData, classList, teacherTitle);
                             alert("アップロードしました。\nこれで他の端末からも同じIDでアクセスできます。");
                         }
                         setIsCloudLoaded(true);
                     }
                } catch(e) { 
                    console.error(e);
                    alert(`接続エラーが発生しました。\nエラー詳細: ${e.message}`);
                }
                finally { setIsSyncing(false); }
            }, [syncId, useCloud, scheduleData, classList, teacherTitle, saveToCloud]); 

            useEffect(() => {
                localStorage.setItem('teachersLogData', JSON.stringify(scheduleData));
            }, [scheduleData]);
            
            useEffect(() => {
                localStorage.setItem('teachersLogClasses', JSON.stringify(classList));
            }, [classList]);
            
            useEffect(() => {
                localStorage.setItem('teacherLogSyncId', syncId);
            }, [syncId]);

            useEffect(() => {
                localStorage.setItem('teacherLogTitle', teacherTitle);
            }, [teacherTitle]);

            const currentMonday = getMonday(currentDate);
            const displayMonth = currentMonday.getMonth() + 1;
            const weekNumber = Math.ceil(currentMonday.getDate() / 7); 

            const weekDates = WEEK_DAYS.map((_, i) => {
                const d = new Date(currentMonday);
                d.setDate(currentMonday.getDate() + i);
                return d;
            });

            const navigateWeek = (direction) => {
                const newDate = new Date(currentMonday);
                newDate.setDate(currentMonday.getDate() + (direction * 7));
                setCurrentDate(newDate);
            };
            
            const navigateMonth = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(currentDate.getMonth() + direction);
                setCurrentDate(newDate);
            };

            const navigateToToday = () => {
                const now = new Date();
                setCurrentDate(now);
                if (viewMode === 'month') {
                    // Stay in month
                } else {
                    setViewMode('week');
                }
            };

            const handleSlotClick = (date, slotId) => {
                setSlotModalInfo({
                    isOpen: true,
                    date: formatDateKey(date),
                    slotId: slotId
                });
            };

            const handleSaveSlot = (dateKey, slotId, newData) => {
                setIsCloudLoaded(true); 

                const updatedSchedule = {
                    ...scheduleData,
                    [dateKey]: {
                        ...(scheduleData[dateKey] || {}),
                        [slotId]: newData
                    }
                };
                setScheduleData(updatedSchedule);
                // Auto-save logic: try to save, but don't alert on failure to avoid annoyance during quick edits
                if (isCloudLoaded) {
                    saveToCloud(updatedSchedule, classList, teacherTitle);
                }
            };

            const handleUpdateClasses = (newClasses) => {
                setIsCloudLoaded(true);
                setClassList(newClasses);
                if (isCloudLoaded) {
                    saveToCloud(scheduleData, newClasses, teacherTitle);
                }
            };
            
            const handleUpdateTeacherTitle = (newTitle) => {
                setIsCloudLoaded(true);
                setTeacherTitle(newTitle);
                if (isCloudLoaded) {
                    saveToCloud(scheduleData, classList, newTitle);
                }
            };

            const handleNavigateFromMonth = (date) => {
                setCurrentDate(date);
                setViewMode('week');
            };

            const handlePrint = () => {
                window.print();
            };

            const handleManualSave = async () => {
                if (!window.confirm("現在のデータをクラウドに上書き保存しますか？")) return;
                setIsSyncing(true);
                const success = await saveToCloud(scheduleData, classList, teacherTitle);
                setIsSyncing(false);
                if (success) {
                    alert("クラウドに保存しました。");
                }
            };

            const handleManualLoad = async () => {
                // Manual load uses the same logic as fetchFromCloud
                await fetchFromCloud();
            };

            const exportData = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                    schedule: scheduleData, 
                    classes: classList,
                    title: teacherTitle
                }));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `weekly_plan_backup_${formatDateKey(new Date())}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const importData = (event) => {
                const fileReader = new FileReader();
                fileReader.readAsText(event.target.files[0], "UTF-8");
                fileReader.onload = e => {
                    const parsed = JSON.parse(e.target.result);
                    if(parsed.schedule) setScheduleData(parsed.schedule);
                    if(parsed.classes) {
                         const rClasses = parsed.classes;
                         if (rClasses.length > 0 && typeof rClasses[0] === 'string') {
                             setClassList(rClasses.map(c => ({ name: c, color: guessColor(c) })));
                         } else {
                             setClassList(rClasses);
                         }
                    }
                    if(parsed.title) setTeacherTitle(parsed.title);
                    
                    setIsCloudLoaded(true);
                    // Try auto save after import
                    saveToCloud(parsed.schedule, parsed.classes, parsed.title || teacherTitle);
                    alert("データを復元しました。");
                };
            };

            const SlotCell = ({ dateKey, slot, date }) => {
                const dayData = scheduleData[dateKey] || {};
                const slotData = dayData[slot.id] || {};
                const text = slotData.plan || slotData.actual || '';
                const isActual = !slotData.plan && slotData.actual; 
                
                const getBadgeStyle = (clsName) => {
                    const clsObj = classList.find(c => c.name === clsName);
                    if (!clsObj) {
                         const guessed = guessColor(clsName);
                         const theme = COLOR_PALETTE[guessed];
                         return `${theme.bgLight} ${theme.text}`;
                    }
                    const theme = COLOR_PALETTE[clsObj.color || 'gray'];
                    return `${theme.bgLight} ${theme.text}`;
                };

                return (
                    <div 
                        className={`
                            border-b border-r border-gray-200 p-1 text-xs relative cursor-pointer hover:bg-blue-50 transition-colors
                            ${slot.height} overflow-hidden group
                            ${slot.id === 'lunch' ? 'bg-gray-100 text-center flex items-center justify-center text-gray-400 print:text-black print:bg-gray-100' : 'bg-white'}
                            print-row
                        `}
                        onClick={() => handleSlotClick(date, slot.id)}
                    >
                        {slot.type === 'class' && slotData.classId && (
                            <span className={`block font-bold mb-1 text-[10px] inline-block px-1.5 py-0.5 rounded ${getBadgeStyle(slotData.classId)} print:border print:border-black print:bg-white print:text-black`}>
                                {slotData.classId}
                            </span>
                        )}
                        
                        <div className="whitespace-pre-wrap leading-tight text-gray-700 print:text-black">
                            {isActual && <span className="text-orange-500 font-bold text-[10px] no-print">[実] </span>}
                            {text}
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-screen flex flex-col bg-gray-50 text-gray-800 print:bg-white print:h-auto">
                    <header className="bg-white border-b shadow-sm px-4 py-3 flex items-center justify-between z-10 shrink-0 no-print">
                        <div className="flex items-center gap-4">
                            <div className="bg-blue-600 text-white p-2 rounded-lg shadow">
                                <Icons.Calendar />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold leading-none hidden md:block flex items-center gap-2">
                                    Teacher's Log Pro
                                    <span className="text-xs font-normal text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded border">{APP_VERSION}</span>
                                </h1>
                                <p className="text-xs text-gray-500 font-medium mt-1 flex items-center gap-1">
                                    {teacherTitle} 
                                    {useCloud && (
                                        <span className={`flex items-center gap-1 ml-2 ${isCloudLoaded ? 'text-green-500' : 'text-gray-400'}`}>
                                            <Icons.Cloud size={10} /> {isCloudLoaded ? '同期OK' : '未接続'}
                                        </span>
                                    )}
                                </p>
                            </div>
                        </div>

                        <div className="flex bg-gray-100 p-1 rounded-lg">
                            <button 
                                onClick={() => setViewMode('month')}
                                className={`px-4 py-1.5 rounded-md text-sm font-medium transition ${viewMode === 'month' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                月
                            </button>
                            <button 
                                onClick={() => setViewMode('week')}
                                className={`px-4 py-1.5 rounded-md text-sm font-medium transition ${viewMode === 'week' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                週
                            </button>
                            <button 
                                onClick={() => setViewMode('history')}
                                className={`px-4 py-1.5 rounded-md text-sm font-medium transition ${viewMode === 'history' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                履歴
                            </button>
                            <button 
                                onClick={() => setViewMode('stats')}
                                className={`px-4 py-1.5 rounded-md text-sm font-medium flex items-center gap-1 transition ${viewMode === 'stats' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                <Icons.BarChart /> 集計
                            </button>
                        </div>

                        <div className="flex items-center gap-2 ml-4"> {/* Added ml-4 here */}
                             {useCloud && (
                                 <>
                                     <button onClick={handleManualLoad} className="flex items-center gap-1 bg-gray-100 text-gray-700 px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-200 text-xs font-bold transition mr-1" title="クラウドから最新データを読み込む">
                                         <Icons.RefreshCw size={14} /> 読込
                                     </button>
                                     <button onClick={handleManualSave} className="flex items-center gap-1 bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 text-xs font-bold shadow-sm transition mr-2" title="クラウドへ保存する">
                                         <Icons.Save size={14} /> 保存
                                     </button>
                                 </>
                             )}
                             
                             <button onClick={handlePrint} className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded" title="印刷">
                                <Icons.Printer />
                            </button>
                             <label className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded cursor-pointer">
                                <Icons.Upload />
                                <input type="file" onChange={importData} className="hidden" accept=".json"/>
                            </label>
                            <button onClick={exportData} className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded">
                                <Icons.Download />
                            </button>
                            <button onClick={() => setSettingsOpen(true)} className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded relative">
                                <Icons.Settings />
                                {!isCloudLoaded && useCloud && (
                                    <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                                )}
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-hidden relative flex flex-col print:overflow-visible">
                        <div className="flex items-center justify-between px-6 py-3 bg-white border-b shrink-0 no-print">
                            <div className="flex items-center gap-4">
                                <button onClick={() => viewMode === 'month' ? navigateMonth(-1) : navigateWeek(-1)} className="p-1 hover:bg-gray-100 rounded-full"><Icons.ChevronLeft/></button>
                                <h2 className="text-2xl font-bold font-mono text-gray-800 flex items-baseline gap-2">
                                    {currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月 
                                    {viewMode === 'week' && <span className="text-lg text-gray-400 font-normal">第{weekNumber}週</span>}
                                </h2>
                                <button onClick={() => viewMode === 'month' ? navigateMonth(1) : navigateWeek(1)} className="p-1 hover:bg-gray-100 rounded-full"><Icons.ChevronRight/></button>
                                <button onClick={navigateToToday} className="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">今日</button>
                            </div>
                        </div>

                        {/* Print Header */}
                        <div className="print-only p-4 border-b text-center">
                            <h1 className="text-2xl font-bold">{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月 第{weekNumber}週 週案</h1>
                            <p className="text-sm text-gray-600 text-right">{teacherTitle}</p>
                        </div>

                        <div className="flex-1 overflow-hidden print:overflow-visible">
                            {viewMode === 'week' && (
                                <div className="h-full overflow-auto custom-scrollbar p-4 print:p-0 print:overflow-visible">
                                    <div className="bg-white shadow rounded-lg overflow-hidden border border-gray-200 min-w-[800px] print:shadow-none print:min-w-0 print:border-black">
                                        <div className="grid grid-cols-[80px_repeat(6,1fr)] bg-gray-50 border-b border-gray-200 print:bg-white print:border-black">
                                            <div className="p-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider border-r print:text-black print:border-black">時限</div>
                                            {weekDates.map((date, i) => (
                                                <div key={i} className={`p-2 text-center border-r last:border-r-0 print:border-black ${
                                                    date.toDateString() === new Date().toDateString() ? 'bg-blue-50 print:bg-white' : ''
                                                }`}>
                                                    <div className="text-xs text-gray-500 print:text-black">{WEEK_DAYS[i]}</div>
                                                    <div className={`text-lg font-bold print:text-black ${
                                                        i === 5 ? 'text-blue-600' : 'text-gray-800'
                                                    }`}>
                                                        {date.getDate()}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        {TIME_SLOTS.map(slot => (
                                            <div key={slot.id} className="grid grid-cols-[80px_repeat(6,1fr)] hover:bg-gray-50 transition-colors print:hover:bg-transparent print-row">
                                                <div className={`
                                                    border-b border-r border-gray-200 flex items-center justify-center text-xs font-bold text-gray-600 bg-gray-50 print:bg-white print:text-black print:border-black
                                                    ${slot.id === 'lunch' ? 'bg-gray-100' : ''}
                                                `}>
                                                    {slot.label}
                                                </div>
                                                {weekDates.map((date, i) => (
                                                    <div key={i} className="print:border-b print:border-r print:border-black">
                                                        <SlotCell 
                                                            key={i} 
                                                            dateKey={formatDateKey(date)} 
                                                            slot={slot}
                                                            date={date}
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {viewMode === 'month' && (
                                <MonthView 
                                    currentDate={currentDate} 
                                    data={scheduleData}
                                    classList={classList}
                                    onNavigateToWeek={handleNavigateFromMonth}
                                />
                            )}

                            {viewMode === 'history' && (
                                <div className="h-full p-4">
                                    <ClassHistoryView data={scheduleData} classes={classList} />
                                </div>
                            )}

                            {viewMode === 'stats' && (
                                <div className="h-full p-4">
                                    <StatsView data={scheduleData} classes={classList} />
                                </div>
                            )}
                        </div>
                    </main>

                    <SlotModal 
                        isOpen={slotModalInfo.isOpen}
                        onClose={() => setSlotModalInfo({ ...slotModalInfo, isOpen: false })}
                        date={slotModalInfo.date}
                        slotId={slotModalInfo.slotId}
                        data={scheduleData[slotModalInfo.date]?.[slotModalInfo.slotId]}
                        onSave={handleSaveSlot}
                        classOptions={classList}
                    />

                    <SettingsModal 
                        isOpen={isSettingsOpen}
                        onClose={() => setSettingsOpen(false)}
                        classes={classList}
                        onUpdateClasses={handleUpdateClasses}
                        syncId={syncId}
                        onUpdateSyncId={setSyncId}
                        onTriggerSync={fetchFromCloud}
                        isSyncing={isSyncing}
                        teacherTitle={teacherTitle}
                        onUpdateTeacherTitle={handleUpdateTeacherTitle}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>