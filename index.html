<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>週案マネージャー</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & Babel (安定版) -->
  <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>
  
  <!-- Import Maps -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
  </script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    textarea { font-size: 16px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="root"></div>

  <!-- Main Application Script -->
  <script type="text/babel" data-type="module" data-presets="react">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Calendar, ChevronLeft, ChevronRight, Home, List, CheckCircle2, BookOpen, 
      ClipboardList, ArrowLeft, Calculator, X, Coffee, Sun, Sunset, FileText, 
      Cloud, CloudOff, RefreshCw, Save, AlertTriangle, Settings, Plus, Trash2,
      Download, Upload
    } from 'lucide-react';
    
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from 'firebase/firestore';

    // ----------------------------------------------------
    // Firebase設定 (ここをご自身のAPIキーに書き換えてください)
    // ----------------------------------------------------
    const firebaseConfig = {
      apiKey: "API_KEY_HERE",
      authDomain: "PROJECT_ID.firebaseapp.com",
      projectId: "PROJECT_ID",
      storageBucket: "PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    
    let app, auth, db;
    const appId = "weekly-lesson-plan";
    let isFirebaseReady = false;

    // 設定が書き換えられているかチェック
    if (firebaseConfig.apiKey !== "API_KEY_HERE") {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        isFirebaseReady = true;
      } catch (e) {
        console.error("Firebase init error:", e);
      }
    }

    // --- Constants ---
    const DEFAULT_SUBJECTS = [
      { id: '1A_sci', name: '1A 理科', color: 'bg-blue-100 text-blue-800 border-blue-200' },
      { id: '1B_sci', name: '1B 理科', color: 'bg-cyan-100 text-cyan-800 border-cyan-200' },
      { id: '2A_sci', name: '2A 理科', color: 'bg-green-100 text-green-800 border-green-200' },
      { id: '2B_sci', name: '2B 理科', color: 'bg-emerald-100 text-emerald-800 border-emerald-200' },
      { id: '3A_sci', name: '3A 理科', color: 'bg-indigo-100 text-indigo-800 border-indigo-200' },
      { id: '3B_sci', name: '3B 理科', color: 'bg-violet-100 text-violet-800 border-violet-200' },
      { id: '1A_moral', name: '1A 道徳', color: 'bg-yellow-100 text-yellow-800 border-yellow-200' },
      { id: '1A_hr', name: '1A HR', color: 'bg-pink-100 text-pink-800 border-pink-200' },
      { id: '1A_sougou', name: '1A 総学', color: 'bg-orange-100 text-orange-800 border-orange-200' },
      { id: 'other', name: 'その他', color: 'bg-gray-100 text-gray-800 border-gray-200' },
    ];

    const COLOR_PALETTES = [
      { label: '青', value: 'bg-blue-100 text-blue-800 border-blue-200' },
      { label: '水色', value: 'bg-cyan-100 text-cyan-800 border-cyan-200' },
      { label: '緑', value: 'bg-green-100 text-green-800 border-green-200' },
      { label: '深緑', value: 'bg-emerald-100 text-emerald-800 border-emerald-200' },
      { label: '藍', value: 'bg-indigo-100 text-indigo-800 border-indigo-200' },
      { label: '紫', value: 'bg-violet-100 text-violet-800 border-violet-200' },
      { label: '黄', value: 'bg-yellow-100 text-yellow-800 border-yellow-200' },
      { label: '桃', value: 'bg-pink-100 text-pink-800 border-pink-200' },
      { label: '橙', value: 'bg-orange-100 text-orange-800 border-orange-200' },
      { label: '灰', value: 'bg-gray-100 text-gray-800 border-gray-200' },
    ];

    const PERIODS = [
      { id: 'submission', label: '提出物', shortLabel: '提', type: 'submission', icon: <FileText size={14} /> },
      { id: 'morning_hr', label: '朝HR', shortLabel: '朝', type: 'hr', icon: <Sun size={14} /> },
      { id: 1, label: '1限', shortLabel: '1', type: 'class' },
      { id: 2, label: '2限', shortLabel: '2', type: 'class' },
      { id: 3, label: '3限', shortLabel: '3', type: 'class' },
      { id: 4, label: '4限', shortLabel: '4', type: 'class' },
      { id: 'lunch', label: '昼休み', shortLabel: '昼', type: 'break', icon: <Coffee size={14} /> },
      { id: 5, label: '5限', shortLabel: '5', type: 'class' },
      { id: 6, label: '6限', shortLabel: '6', type: 'class' },
      { id: 7, label: '7限', shortLabel: '7', type: 'class' },
      { id: 'closing_hr', label: '帰HR', shortLabel: '帰', type: 'hr', icon: <Sunset size={14} /> },
    ];

    // --- Utilities ---
    const formatDateKey = (date) => date.toISOString().split('T')[0];
    
    const getDaysInMonth = (year, month) => {
      const date = new Date(year, month, 1);
      const days = [];
      while (date.getMonth() === month) {
        days.push(new Date(date));
        date.setDate(date.getDate() + 1);
      }
      return days;
    };

    const getDaysInWeek = (currentDate) => {
      const tempDate = new Date(currentDate);
      const day = tempDate.getDay(); 
      const diffToMonday = day === 0 ? -6 : 1 - day;
      const monday = new Date(tempDate);
      monday.setDate(tempDate.getDate() + diffToMonday);
      const days = [];
      for (let i = 0; i < 6; i++) {
        const nextDate = new Date(monday);
        nextDate.setDate(monday.getDate() + i);
        days.push(nextDate);
      }
      return days;
    };

    const getDayName = (date) => ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];

    // --- Error Boundary ---
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-red-50 p-6">
              <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full border border-red-100 text-center">
                <div className="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                    <AlertTriangle className="text-red-600" size={32} />
                </div>
                <h2 className="text-2xl font-bold text-slate-800 mb-2">問題が発生しました</h2>
                <p className="text-slate-600 mb-6">再読み込みを行ってください。</p>
                <button onClick={() => window.location.reload()} className="w-full bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-slate-700 transition">
                  <RefreshCw size={18} className="inline mr-2" /> 再読み込み
                </button>
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // --- Main Component ---
    function WeeklyLessonPlanner() {
      // State
      const [view, setView] = useState('week'); 
      const [currentDate, setCurrentDate] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [scheduleData, setScheduleData] = useState({});
      const [subjects, setSubjects] = useState(DEFAULT_SUBJECTS);
      const [className, setClassName] = useState('1A');
      
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [selectedSubjectHistory, setSelectedSubjectHistory] = useState(null);
      const [quickMenu, setQuickMenu] = useState(null);
      const [showCloudModal, setShowCloudModal] = useState(false);

      // Cloud State
      const [user, setUser] = useState(null);
      const [syncId, setSyncId] = useState(''); 
      const [isSyncing, setIsSyncing] = useState(false);
      const [lastSynced, setLastSynced] = useState(null);
      const [cloudError, setCloudError] = useState('');
      const [localLastEditedAt, setLocalLastEditedAt] = useState(new Date(0)); 
      const initialLoadDone = useRef(false);

      // Initialize
      useEffect(() => {
        if (subjects.length > 0 && !selectedSubjectHistory) {
          setSelectedSubjectHistory(subjects[0].id);
        }
        // Load Local Storage
        try {
            const savedData = localStorage.getItem('lessonPlanData');
            if (savedData) setScheduleData(JSON.parse(savedData));
            const savedSettings = localStorage.getItem('lessonPlanSettings');
            if (savedSettings) {
                const parsed = JSON.parse(savedSettings);
                if (parsed.subjects) setSubjects(parsed.subjects);
                if (parsed.className) setClassName(parsed.className);
            }
            setLocalLastEditedAt(new Date());
            const savedSyncId = localStorage.getItem('lessonPlanSyncId');
            if (savedSyncId) setSyncId(savedSyncId);
        } catch (e) { console.error(e); }

        // Firebase Auth
        if (isFirebaseReady) {
          signInAnonymously(auth).catch(e => console.error("Auth Error", e));
          const unsubscribe = onAuthStateChanged(auth, setUser);
          return () => unsubscribe();
        }
      }, []);

      // Cloud Sync Listener
      useEffect(() => {
        if (!isFirebaseReady || !user || !syncId) return;
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_plans', syncId);
        setIsSyncing(true);
        const unsubscribe = onSnapshot(docRef, (docSnap) => {
          if (docSnap.exists()) {
            const remoteData = docSnap.data();
            let remoteTime = new Date(0);
            if (remoteData.updatedAt?.toDate) remoteTime = remoteData.updatedAt.toDate();
            else if (remoteData.updatedAt) remoteTime = new Date(remoteData.updatedAt);

            const isRemoteEmpty = !remoteData.scheduleData || Object.keys(remoteData.scheduleData).length === 0;
            const isLocalNotEmpty = Object.keys(scheduleData).length > 0;
            
            if (isRemoteEmpty && isLocalNotEmpty) {
                setIsSyncing(false); return; 
            }

            const isRemoteNewer = remoteTime.getTime() > localLastEditedAt.getTime();
            const isFirstSync = !initialLoadDone.current;

            if (isRemoteNewer || (isFirstSync && !isLocalNotEmpty)) {
                if (remoteData.scheduleData) setScheduleData(remoteData.scheduleData);
                if (remoteData.settings) {
                    if (remoteData.settings.subjects) setSubjects(remoteData.settings.subjects);
                    if (remoteData.settings.className) setClassName(remoteData.settings.className);
                }
                setLastSynced(remoteTime);
                setLocalLastEditedAt(remoteTime);
            }
            initialLoadDone.current = true;
          } else { initialLoadDone.current = true; }
          setIsSyncing(false);
        }, (error) => { setIsSyncing(false); setCloudError("同期エラー"); });
        return () => unsubscribe();
      }, [user, syncId]);

      // Save Data
      useEffect(() => {
        localStorage.setItem('lessonPlanData', JSON.stringify(scheduleData));
        localStorage.setItem('lessonPlanSettings', JSON.stringify({ subjects, className }));
        
        if (!isFirebaseReady || (Object.keys(scheduleData).length === 0 && subjects.length === DEFAULT_SUBJECTS.length)) return;

        const timeoutId = setTimeout(async () => {
          if (user && syncId) {
            setIsSyncing(true);
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_plans', syncId);
                const now = new Date();
                await setDoc(docRef, {
                    scheduleData, settings: { subjects, className }, updatedAt: now, updatedBy: user.uid
                }, { merge: true });
                setLastSynced(now);
                setLocalLastEditedAt(now);
            } catch (error) { console.error("Save failed", error); } 
            finally { setIsSyncing(false); }
          }
        }, 1500);
        return () => clearTimeout(timeoutId);
      }, [scheduleData, subjects, className, user, syncId]);

      // --- Helper Functions ---
      const handleDataChange = () => setLocalLastEditedAt(new Date());
      
      const updatePeriodData = (dateKey, periodId, field, value) => {
        setScheduleData(prev => {
          const newData = { ...prev };
          if (!newData[dateKey]) newData[dateKey] = { periods: {} };
          if (!newData[dateKey].periods) newData[dateKey].periods = {};
          if (!newData[dateKey].periods[periodId]) newData[dateKey].periods[periodId] = { subject: '', plan: '', result: '' };
          newData[dateKey].periods[periodId][field] = value;
          return newData;
        });
        handleDataChange();
      };

      const toggleSubject = (dateKey, periodId, subjectName) => {
        const currentSubject = scheduleData[dateKey]?.periods?.[periodId]?.subject;
        const newValue = currentSubject === subjectName ? '' : subjectName;
        updatePeriodData(dateKey, periodId, 'subject', newValue);
      };

      const updateDayData = (dateKey, field, value) => {
        setScheduleData(prev => {
          const newData = { ...prev };
          if (!newData[dateKey]) newData[dateKey] = { periods: {} };
          newData[dateKey][field] = value;
          return newData;
        });
        handleDataChange();
      };

      const getDayData = (date) => scheduleData[formatDateKey(date)] || { periods: {} };
      
      // *** ここで goToToday を定義 ***
      const goToToday = () => { 
        const t = new Date(); 
        setCurrentDate(t); 
        setSelectedDate(t); 
      };
      
      const handlePrev = () => { 
        const d = new Date(currentDate); 
        view === 'month' ? d.setMonth(d.getMonth()-1) : d.setDate(d.getDate()-7); 
        setCurrentDate(d); 
      };
      
      const handleNext = () => { 
        const d = new Date(currentDate); 
        view === 'month' ? d.setMonth(d.getMonth()+1) : d.setDate(d.getDate()+7); 
        setCurrentDate(d); 
      };

      // Settings Logic
      const handleAddSubject = () => setSubjects([...subjects, { id: `custom_${Date.now()}`, name: '新規科目', color: COLOR_PALETTES[0].value }]);
      const handleUpdateSubject = (id, field, value) => setSubjects(subjects.map(s => s.id === id ? { ...s, [field]: value } : s));
      const handleDeleteSubject = (id) => { if(confirm('削除しますか？')) setSubjects(subjects.filter(s => s.id !== id)); };
      
      const handleExportData = () => {
        const dataStr = JSON.stringify({ scheduleData, settings: { subjects, className } }, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `週案バックアップ_${formatDateKey(new Date())}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const handleImportData = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const imported = JSON.parse(ev.target.result);
            if (imported.scheduleData) setScheduleData(imported.scheduleData);
            if (imported.settings) {
                if (imported.settings.subjects) setSubjects(imported.settings.subjects);
                if (imported.settings.className) setClassName(imported.settings.className);
            }
            setLocalLastEditedAt(new Date());
            alert("データを復元しました");
          } catch (err) { alert("ファイルエラー"); }
        };
        reader.readAsText(file);
      };

      const calculateSubjectCounts = () => {
        const counts = {};
        subjects.forEach(s => counts[s.name] = 0);
        Object.values(scheduleData).forEach(day => {
          if (day.periods) {
            Object.values(day.periods).forEach(p => {
              if (p.subject && counts[p.subject] !== undefined) counts[p.subject]++;
            });
          }
        });
        return counts;
      };

      // --- Render Functions (Defined Inside Component) ---
      
      // 1. Quick Menu
      const renderQuickMenu = () => {
        if (!quickMenu) return null;
        const { dateKey, periodId, label, type } = quickMenu;
        const periodData = scheduleData[dateKey]?.periods?.[periodId] || { subject: '', plan: '', result: '' };
        const currentSubject = periodData.subject;
        const currentPlan = periodData.plan || '';
        const currentResult = periodData.result || '';
        let placeholder = "予定・内容を入力...";
        if (type === 'submission') placeholder = "提出物内容...";
        else if (type === 'hr') placeholder = "連絡事項...";
        else if (type === 'break') placeholder = "給食指導など...";

        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/20 backdrop-blur-sm" onClick={() => setQuickMenu(null)}>
            <div className="bg-white rounded-2xl shadow-xl border border-slate-200 p-5 w-[90%] max-w-md flex flex-col max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <h3 className="font-bold text-lg text-slate-700 flex items-center gap-2">
                  <span className={`min-w-8 h-8 px-2 rounded-lg flex items-center justify-center text-sm ${type === 'submission' ? 'bg-red-500 text-white' : 'bg-slate-800 text-white'}`}>{label}</span>
                  <span>入力</span>
                </h3>
                <button onClick={() => setQuickMenu(null)} className="p-1 hover:bg-slate-100 rounded-full text-slate-400"><X size={20} /></button>
              </div>
              <div className="flex-1 overflow-y-auto">
                {type === 'class' && (
                  <div className="mb-4">
                    <label className="block text-xs font-bold text-slate-400 mb-2">科目</label>
                    <div className="grid grid-cols-2 gap-3">
                      {subjects.map(s => (
                        <button key={s.id} onClick={() => toggleSubject(dateKey, periodId, s.name)} className={`p-3 rounded-xl text-sm font-bold border-2 text-left flex items-center gap-2 ${currentSubject === s.name ? `${s.color.replace('border-', 'border-current ')} ring-2 ring-blue-200` : 'bg-white border-slate-100 text-slate-600'}`}>
                          <span className={`w-3 h-3 rounded-full ${s.color.split(' ')[0]}`}></span>{s.name}{currentSubject === s.name && <CheckCircle2 className="ml-auto w-4 h-4" />}
                        </button>
                      ))}
                    </div>
                    <div className="mt-2 text-right"><button onClick={() => toggleSubject(dateKey, periodId, currentSubject)} className="text-xs text-slate-400 underline">解除</button></div>
                  </div>
                )}
                <div className="mb-4">
                  <label className="block text-xs font-bold text-slate-400 mb-2">{type === 'class' ? '予定' : '内容'}</label>
                  <textarea value={currentPlan} onChange={(e) => updatePeriodData(dateKey, periodId, 'plan', e.target.value)} placeholder={placeholder} className="w-full h-32 p-3 text-sm bg-slate-50 border border-slate-200 rounded-lg outline-none" />
                </div>
                {type === 'class' && (
                  <div className="mb-4">
                    <label className="block text-xs font-bold text-green-600/70 mb-2">実績</label>
                    <textarea value={currentResult} onChange={(e) => updatePeriodData(dateKey, periodId, 'result', e.target.value)} placeholder="実施内容..." className="w-full h-24 p-3 text-sm bg-slate-50 border border-slate-200 rounded-lg outline-none" />
                  </div>
                )}
              </div>
              <div className="mt-4 pt-3 border-t border-slate-100">
                 <button onClick={() => setQuickMenu(null)} className="w-full bg-slate-800 text-white font-bold py-2.5 rounded-xl flex items-center justify-center gap-2"><CheckCircle2 size={18} />完了</button>
              </div>
            </div>
          </div>
        );
      };

      // 2. Settings Modal
      const renderSettingsModal = () => {
        if (!showSettingsModal) return null;
        return (
          <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm" onClick={() => setShowSettingsModal(false)}>
            <div className="bg-white rounded-2xl shadow-xl border border-slate-200 p-6 w-[95%] max-w-2xl max-h-[90vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2"><Settings className="text-slate-500" /> 設定</h3>
                <button onClick={() => setShowSettingsModal(false)} className="p-1 hover:bg-slate-100 rounded-full text-slate-400"><X size={24} /></button>
              </div>
              <div className="flex-1 overflow-y-auto space-y-8 pr-2">
                <section>
                    <h4 className="font-bold text-slate-600 mb-3 text-sm">クラス名</h4>
                    <div className="flex items-center gap-4">
                        <div className="w-16 h-16 bg-slate-800 rounded-xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">{className}</div>
                        <input type="text" value={className} onChange={(e) => setClassName(e.target.value)} className="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-lg font-bold" />
                    </div>
                </section>
                <section>
                    <div className="flex justify-between items-center mb-3">
                        <h4 className="font-bold text-slate-600 text-sm">科目リスト</h4>
                        <button onClick={handleAddSubject} className="flex items-center gap-1 text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full font-bold"><Plus size={14} /> 追加</button>
                    </div>
                    <div className="space-y-3">
                        {subjects.map((subject) => (
                            <div key={subject.id} className="flex gap-2 items-center bg-white border border-slate-100 p-2 rounded-lg">
                                <select value={subject.color} onChange={(e) => handleUpdateSubject(subject.id, 'color', e.target.value)} className={`h-10 w-24 rounded-md text-xs p-1 cursor-pointer ${subject.color}`}>
                                    {COLOR_PALETTES.map(c => <option key={c.label} value={c.value} className="bg-white text-slate-800">{c.label}</option>)}
                                </select>
                                <input type="text" value={subject.name} onChange={(e) => handleUpdateSubject(subject.id, 'name', e.target.value)} className="flex-1 p-2 bg-slate-50 border border-slate-200 rounded text-sm font-bold" />
                                <button onClick={() => handleDeleteSubject(subject.id)} className="p-2 text-slate-300 hover:text-red-500 rounded"><Trash2 size={16} /></button>
                            </div>
                        ))}
                    </div>
                </section>
                <section className="pt-4 border-t border-slate-100">
                    <h4 className="font-bold text-slate-600 mb-3 text-sm flex items-center gap-2"><Save size={16}/> バックアップ</h4>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={handleExportData} className="flex items-center justify-center gap-2 p-3 bg-blue-50 text-blue-700 rounded-lg border border-blue-200"><Download size={18} /> 保存 (Export)</button>
                        <label className="flex items-center justify-center gap-2 p-3 bg-slate-50 text-slate-700 rounded-lg border border-slate-200 cursor-pointer">
                            <Upload size={18} /> 復元 (Import)
                            <input type="file" accept=".json" onChange={handleImportData} className="hidden" />
                        </label>
                    </div>
                </section>
              </div>
              <div className="mt-6 pt-4 border-t border-slate-100 text-right">
                <button onClick={() => setShowSettingsModal(false)} className="bg-slate-800 text-white font-bold px-6 py-3 rounded-xl shadow-sm">保存して閉じる</button>
              </div>
            </div>
          </div>
        );
      };

      // 3. Cloud Modal
      const renderCloudModal = () => {
        if (!showCloudModal) return null;
        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm" onClick={() => setShowCloudModal(false)}>
            <div className="bg-white rounded-2xl shadow-xl border border-slate-200 p-6 w-[90%] max-w-md" onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Cloud className="text-blue-500" /> 同期設定</h3>
                <button onClick={() => setShowCloudModal(false)} className="p-1 hover:bg-slate-100 rounded-full text-slate-400"><X size={20} /></button>
              </div>
              <div className="bg-blue-50 border border-blue-100 p-3 rounded-lg text-xs text-blue-800 mb-4">
                 <strong>アーカイブ機能:</strong> 合言葉を変えることで年度を切り替えられます。<br/>(例: <code>2025-classA</code> → <code>2026-classB</code>)
              </div>
              <div className="space-y-4">
                <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">合言葉 (Sync ID)</label>
                    <input type="text" value={syncId} onChange={(e) => { setSyncId(e.target.value); localStorage.setItem('lessonPlanSyncId', e.target.value); }} placeholder="例: yamada-1a-2026" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg font-mono text-lg" />
                </div>
                <div className="flex items-center gap-2 text-xs text-slate-500 bg-slate-50 p-3 rounded border border-slate-100">
                    {isSyncing ? <RefreshCw className="animate-spin text-blue-500" size={14} /> : <CheckCircle2 className="text-green-500" size={14} />}
                    {isSyncing ? "同期中..." : lastSynced ? `最終同期: ${lastSynced.toLocaleTimeString()}` : "接続待機中"}
                </div>
                {cloudError && <div className="text-xs text-red-500 bg-red-50 p-2 rounded">{cloudError}</div>}
                <button onClick={() => setShowCloudModal(false)} className="w-full bg-blue-600 text-white font-bold py-2 rounded-lg">閉じる</button>
              </div>
            </div>
          </div>
        );
      };

      // 4. Week View
      const renderWeekView = () => {
        const days = getDaysInWeek(currentDate);
        return (
          <div className="grid grid-cols-6 gap-2 h-full">
            {days.map((day, i) => {
              const dateKey = formatDateKey(day);
              const data = scheduleData[dateKey];
              const isToday = formatDateKey(new Date()) === dateKey;
              const isSaturday = day.getDay() === 6;
              return (
                <div key={dateKey} className={`flex flex-col bg-white rounded-xl shadow-sm border ${isToday ? 'border-blue-400 ring-2 ring-blue-100' : 'border-slate-200'} transition-all`}>
                  <div onClick={() => { setSelectedDate(day); setView('day'); }} className={`p-3 text-center border-b border-slate-100 ${isToday ? 'bg-blue-50' : isSaturday ? 'bg-blue-50/30' : ''} rounded-t-xl cursor-pointer hover:bg-slate-100`}>
                    <div className={`text-xs font-bold ${isSaturday ? 'text-blue-500' : 'text-slate-500'}`}>{getDayName(day)}</div>
                    <div className={`text-xl font-bold mt-1 ${isToday ? 'text-blue-700' : 'text-slate-700'}`}>{day.getDate()}</div>
                  </div>
                  <div onClick={() => { setSelectedDate(day); setView('day'); }} className="px-2 py-2 min-h-[40px] border-b border-slate-50 cursor-pointer hover:bg-slate-50">
                    {data?.event ? <div className="text-xs bg-red-50 text-red-600 border border-red-100 px-1.5 py-0.5 rounded mb-1 font-medium text-center line-clamp-2">{data.event}</div> : <div className="text-[10px] text-slate-300 text-center py-1">行事なし</div>}
                  </div>
                  <div className="flex-1 p-2 space-y-2 overflow-y-auto">
                    {PERIODS.map(period => {
                      const pData = data?.periods?.[period.id];
                      const hasContent = pData && (pData.subject || pData.plan || pData.result);
                      const subj = pData?.subject ? subjects.find(s => s.name === pData.subject) : null;
                      
                      let containerClass = "min-h-[60px]";
                      let bgClass = "";
                      if (hasContent) {
                        if (period.type === 'submission') bgClass = "bg-red-50 border-red-200 text-red-700";
                        else if (period.type === 'hr') bgClass = "bg-orange-100 border-orange-200 text-orange-800";
                        else if (period.type === 'break') bgClass = "bg-slate-200 border-slate-300 text-slate-700";
                        else if (subj) bgClass = subj.color;
                        else bgClass = "bg-white border-slate-200";
                      } else {
                        if (period.type === 'submission') bgClass = "bg-slate-50/30 border-slate-200 text-slate-400";
                        else if (period.type === 'hr') bgClass = "bg-orange-50/30 border-orange-100 border-dashed text-orange-300";
                        else if (period.type === 'break') bgClass = "bg-slate-100 text-slate-400 border-transparent";
                        else bgClass = "bg-slate-50/50 border-dashed border-slate-300 text-slate-400";
                      }
                      if (period.type === 'submission') containerClass = "min-h-[36px] mb-2";
                      else if (period.type === 'hr') containerClass = "min-h-[40px]";
                      else if (period.type === 'break') containerClass = "min-h-[30px] border-transparent";

                      return (
                        <div key={period.id} onClick={() => setQuickMenu({ dateKey, periodId: period.id, label: period.label, type: period.type })} className={`relative text-xs p-1.5 rounded border flex flex-col cursor-pointer transition-all hover:ring-2 hover:ring-blue-300 ${containerClass} ${bgClass}`}>
                          <div className="flex justify-between items-center mb-0.5">
                            <span className={`font-bold opacity-70 flex items-center gap-1 ${period.type === 'class' ? 'border-b border-current pb-0.5' : ''}`}>{period.icon}{period.label}</span>
                            {period.type === 'class' && <div className="font-bold text-[10px] ml-1 text-right leading-tight truncate max-w-[50px]">{pData?.subject || <span className="opacity-30"></span>}</div>}
                          </div>
                          {pData?.plan ? <div className={`opacity-90 text-[11px] leading-tight line-clamp-2 mt-0.5 ${period.type === 'submission' ? 'font-bold' : ''}`}>{pData.plan}</div> : <div className="flex-1"></div>}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        );
      };

      // 5. Month View
      const renderMonthView = () => {
        const days = getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth());
        const blanks = Array(days[0].getDay()).fill(null);
        const displayPeriods = PERIODS.filter(p => p.type === 'class');
        return (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div className="grid grid-cols-7 bg-slate-50 border-b border-slate-200">
              {['日', '月', '火', '水', '木', '金', '土'].map((d, i) => <div key={i} className={`py-3 text-center font-bold text-sm ${i === 0 ? 'text-red-300' : i === 6 ? 'text-blue-500' : 'text-slate-600'}`}>{d}</div>)}
            </div>
            <div className="grid grid-cols-7 auto-rows-fr">
              {blanks.map((_, i) => <div key={`blank-${i}`} className="h-32 border-b border-r border-slate-100 bg-slate-50/30" />)}
              {days.map(day => {
                const dateKey = formatDateKey(day);
                const data = scheduleData[dateKey];
                const isToday = formatDateKey(new Date()) === dateKey;
                const isSunday = day.getDay() === 0;
                return (
                  <div key={dateKey} onClick={() => { setSelectedDate(day); setView('day'); }} className={`h-32 border-b border-r border-slate-100 p-2 cursor-pointer transition relative ${isSunday ? 'bg-slate-50 opacity-60' : 'hover:bg-slate-50'} ${isToday ? 'bg-blue-50/50' : ''}`}>
                    <div className={`text-sm font-medium mb-1 inline-block w-6 h-6 text-center leading-6 rounded-full ${isToday ? 'bg-blue-600 text-white' : isSunday ? 'text-red-300' : 'text-slate-700'}`}>{day.getDate()}</div>
                    {data?.event && <div className="text-xs bg-red-100 text-red-700 px-1 py-0.5 rounded truncate mb-1">{data.event}</div>}
                    {!isSunday && <div className="space-y-0.5 overflow-hidden h-16">
                        {displayPeriods.map(period => {
                          const pData = data?.periods?.[period.id];
                          if (!pData || !pData.subject) return null;
                          const subj = subjects.find(s => s.name === pData.subject);
                          return (
                            <div key={period.id} className="flex items-center text-[10px]">
                              <span className="w-3 text-slate-400 mr-0.5">{period.shortLabel}</span>
                              <div className={`w-2 h-2 rounded-full mr-1 ${subj ? subj.color.split(' ')[0] : 'bg-gray-300'}`}></div>
                              <span className="truncate text-slate-600">{pData.subject}</span>
                            </div>
                          );
                        })}
                      </div>}
                  </div>
                );
              })}
            </div>
          </div>
        );
      };

      // 6. Day View
      const renderDayView = () => {
        const dateKey = formatDateKey(selectedDate);
        const data = getDayData(selectedDate);
        return (
          <div className="max-w-4xl mx-auto space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300">
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                  <span className="bg-slate-800 text-white px-3 py-1 rounded-lg text-lg">{selectedDate.getMonth() + 1}/{selectedDate.getDate()}</span>
                  <span className="text-slate-500 text-lg">({getDayName(selectedDate)}) の記録</span>
                </h2>
                <div className="flex gap-2">
                    <button onClick={() => { const p = new Date(selectedDate); p.setDate(p.getDate() - 1); setSelectedDate(p); }} className="p-2 hover:bg-slate-100 rounded-full text-slate-500"><ChevronLeft size={20} /></button>
                    <button onClick={() => { const n = new Date(selectedDate); n.setDate(n.getDate() + 1); setSelectedDate(n); }} className="p-2 hover:bg-slate-100 rounded-full text-slate-500"><ChevronRight size={20} /></button>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <label className="text-sm font-bold text-slate-500 flex items-center gap-1"><ClipboardList size={16} /> 行事・特記事項</label>
                  <input type="text" value={data.event || ''} onChange={(e) => updateDayData(dateKey, 'event', e.target.value)} placeholder="例：避難訓練" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg" />
                </div>
                <div className="space-y-2">
                  <label className="text-sm font-bold text-slate-500 flex items-center gap-1"><CheckCircle2 size={16} /> To Do</label>
                  <input type="text" value={data.todo || ''} onChange={(e) => updateDayData(dateKey, 'todo', e.target.value)} placeholder="例：提出物確認" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg" />
                </div>
              </div>
            </div>
            <div className="space-y-4">
              {PERIODS.map(period => {
                const pData = data?.periods?.[period.id] || { subject: '', plan: '', result: '' };
                const subj = subjects.find(s => s.name === pData.subject);
                let headerBg = subj ? subj.color.replace('text-', 'bg-opacity-20 ') : 'bg-slate-50';
                if (period.type === 'break' && !subj) headerBg = 'bg-slate-100';
                if (period.type === 'submission') headerBg = 'bg-red-50 text-red-700';
                if (period.type === 'hr') headerBg = 'bg-orange-50 text-orange-800';
                const textAreaHeight = period.type === 'hr' ? 'h-64' : 'h-24';

                return (
                  <div key={period.id} className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden`}>
                    <div className={`flex items-center p-4 ${headerBg}`}>
                      <div className={`w-12 h-12 flex items-center justify-center bg-white rounded-full font-bold text-slate-700 shadow-sm mr-4 border border-slate-100 ${period.type === 'class' ? 'text-xl' : 'text-sm'}`}>{period.shortLabel}</div>
                      <div className="flex-1">
                        {period.type === 'class' && <div className="flex flex-wrap gap-2 mb-2">{subjects.map(s => <button key={s.id} onClick={() => toggleSubject(dateKey, period.id, s.name)} className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${pData.subject === s.name ? `${s.color} ring-2 ring-offset-1` : 'bg-white text-slate-400 border border-slate-200'}`}>{s.name}</button>)}</div>}
                        {period.type !== 'class' && <div className="font-bold">{period.type === 'submission' ? '提出物' : (period.type === 'hr' ? '連絡' : '内容')}</div>}
                      </div>
                      <div className="text-slate-400 font-bold text-sm ml-2">{period.label}</div>
                    </div>
                    {period.type === 'class' ? (
                      <div className="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-100">
                        <div className="p-4 bg-white">
                          <label className="block text-xs font-bold text-slate-400 mb-2">予定</label>
                          <textarea value={pData.plan} onChange={(e) => updatePeriodData(dateKey, period.id, 'plan', e.target.value)} placeholder="予定..." className={`w-full ${textAreaHeight} p-3 text-sm bg-slate-50/50 border border-slate-200 rounded-lg`} />
                        </div>
                        <div className="p-4 bg-white">
                          <label className="block text-xs font-bold text-slate-400 mb-2">実績</label>
                          <textarea value={pData.result} onChange={(e) => updatePeriodData(dateKey, period.id, 'result', e.target.value)} placeholder="実績..." className={`w-full ${textAreaHeight} p-3 text-sm bg-slate-50/50 border border-slate-200 rounded-lg`} />
                        </div>
                      </div>
                    ) : (
                      <div className="p-4 bg-white">
                        <label className="block text-xs font-bold text-slate-400 mb-2">内容</label>
                        <textarea value={pData.plan} onChange={(e) => updatePeriodData(dateKey, period.id, 'plan', e.target.value)} placeholder="内容..." className={`w-full ${textAreaHeight} p-3 text-sm bg-slate-50/50 border border-slate-200 rounded-lg`} />
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            <div className="h-12"></div>
          </div>
        );
      };

      // 7. History View
      const renderHistoryView = () => {
        const subjectCounts = calculateSubjectCounts();
        const historyList = [];
        Object.keys(scheduleData).forEach(dateKey => {
          const dayData = scheduleData[dateKey];
          if (dayData.periods) {
            PERIODS.forEach(period => {
              const pData = dayData.periods[period.id];
              if (!pData) return;
              const targetSubjName = subjects.find(s => s.id === selectedSubjectHistory)?.name;
              if (pData.subject === targetSubjName && (pData.plan || pData.result)) {
                historyList.push({ date: dateKey, periodLabel: period.label, periodShort: period.shortLabel, ...pData });
              }
            });
          }
        });
        historyList.sort((a, b) => new Date(b.date) - new Date(a.date));
        const currentSubj = subjects.find(s => s.id === selectedSubjectHistory);

        return (
          <div className="max-w-4xl mx-auto space-y-6">
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><Calculator size={20} /> 授業数</h2>
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                {subjects.map(s => <div key={s.id} className={`p-3 rounded-lg border ${s.color.replace('text-', 'border-').replace('bg-', 'bg-opacity-10 ')}`}><div className="text-xs font-bold opacity-70 mb-1">{s.name}</div><div className="text-2xl font-bold">{subjectCounts[s.name]}<span className="text-xs font-normal ml-1 opacity-60">回</span></div></div>)}
              </div>
            </div>
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 min-h-[600px] flex flex-col">
              <div className="p-6 border-b border-slate-100 bg-slate-50/50 rounded-t-2xl">
                <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><BookOpen size={20} /> 科目別記録</h2>
                <div className="flex overflow-x-auto pb-2 gap-2 no-scrollbar">
                  {subjects.map(s => <button key={s.id} onClick={() => setSelectedSubjectHistory(s.id)} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all ${selectedSubjectHistory === s.id ? `${s.color} shadow-sm ring-1 ring-slate-200` : 'bg-white text-slate-500 border border-slate-200 hover:bg-slate-100'}`}>{s.name}</button>)}
                </div>
              </div>
              <div className="flex-1 p-6 overflow-y-auto">
                {historyList.length === 0 ? <div className="text-center text-slate-400 py-20"><ClipboardList className="mx-auto mb-4 opacity-20" size={48} /><p>記録なし</p></div> : 
                  <div className="relative border-l-2 border-slate-100 ml-4 space-y-8">
                    {historyList.map((item) => (
                      <div key={`${item.date}-${item.periodLabel}`} className="relative pl-8">
                        <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 border-white shadow-sm ${currentSubj?.color?.split(' ')[0] || 'bg-gray-300'}`}></div>
                        <div className="mb-1 text-sm text-slate-400 font-mono flex items-center gap-2">{item.date} <span className="text-xs bg-slate-100 px-1.5 rounded text-slate-500">{item.periodLabel}</span></div>
                        <div className="bg-slate-50 rounded-lg p-4 border border-slate-100 hover:border-slate-300 transition-colors group">
                           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div><div className="text-xs font-bold text-slate-400 mb-1">Plan</div><p className="text-slate-700 whitespace-pre-wrap">{item.plan || <span className="text-slate-300 italic">なし</span>}</p></div>
                              <div className="md:border-l md:border-slate-200 md:pl-4"><div className="text-xs font-bold text-green-600/70 mb-1">Result</div><p className="text-slate-700 whitespace-pre-wrap">{item.result || <span className="text-slate-300 italic">なし</span>}</p></div>
                           </div>
                        </div>
                      </div>
                    ))}
                  </div>
                }
              </div>
            </div>
          </div>
        );
      };

      // --- Main Render ---
      return (
        <div className="min-h-screen bg-slate-50 text-slate-800 font-sans selection:bg-blue-100 pb-20">
          {renderQuickMenu()} {renderCloudModal()} {renderSettingsModal()}
          
          <nav className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm px-4 h-16 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-slate-800 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">{className}</div>
              <h1 className="font-bold text-lg hidden sm:block text-slate-700">週案マネージャー</h1>
            </div>
            <div className="flex items-center bg-slate-100 p-1 rounded-lg">
              <button onClick={() => { setView('week'); goToToday(); }} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-1 ${view === 'week' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Calendar size={16} /> 週</button>
              <button onClick={() => { setView('month'); goToToday(); }} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-1 ${view === 'month' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Calendar size={16} /> 月</button>
              <button onClick={() => setView('history')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-1 ${view === 'history' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><List size={16} /> リスト</button>
            </div>
            <div className="flex gap-2">
               <button onClick={()=>setShowSettingsModal(true)} className="p-2 bg-slate-100 rounded"><Settings size={20}/></button>
               <button onClick={()=>setShowCloudModal(true)} className={`p-2 rounded border ${isFirebaseReady ? 'bg-blue-50 text-blue-600' : 'bg-slate-100 text-slate-400'}`}><Cloud size={20}/></button>
            </div>
          </nav>

          <main className="p-4 sm:p-6 max-w-[1600px] mx-auto h-[calc(100vh-80px)]">
             {view === 'week' && renderWeekView()}
             {view === 'month' && renderMonthView()}
             {view === 'day' && renderDayView()}
             {view === 'history' && renderHistoryView()}
          </main>
          <div className="fixed bottom-6 right-6 pointer-events-none opacity-0 transition-opacity duration-500" id="save-indicator">
            <div className="bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2"><CheckCircle2 size={16} className="text-green-400" /> 保存しました</div>
          </div>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <WeeklyLessonPlanner />
      </ErrorBoundary>
    );
  </script>
</body>
</html>
